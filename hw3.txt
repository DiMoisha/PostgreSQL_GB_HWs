-- Урок 3. Связность в структуре базы данных, использование сложных и пользовательских типов данных

-- 1. Создать все необходимые внешние ключи в базе данных vk. В качестве отчёта сдать команды создания ключей в текстовом виде.

-- Создадим внешний ключ для столбца main_photo_id
-- ALTER TABLE users DROP CONSTRAINT users_main_photo_id_fk;
ALTER TABLE users 
  ADD CONSTRAINT users_main_photo_id_fk 
  FOREIGN KEY (main_photo_id) 
  REFERENCES photo (id);

-- Фото и видео, внешний ключ на столбец владелец. При удалении владельца - удаляем и его контент.
ALTER TABLE video 
  ADD CONSTRAINT video_owner_id_fk 
  FOREIGN KEY (owner_id) 
  REFERENCES users (id)
  ON DELETE CASCADE;
  
ALTER TABLE photo 
  ADD CONSTRAINT video_owner_id_fk 
  FOREIGN KEY (owner_id) 
  REFERENCES users (id)
  ON DELETE CASCADE;

-- Таблица сообщений внешние ключи на столбцы from_user_id и to_user_id
-- ALTER TABLE messages DROP CONSTRAINT messages_from_user_id_fk;
ALTER TABLE messages 
  ADD CONSTRAINT messages_from_user_id_fk 
  FOREIGN KEY (from_user_id) 
  REFERENCES users (id)
  ON DELETE CASCADE;

ALTER TABLE messages 
  ADD CONSTRAINT messages_to_user_id_fk 
  FOREIGN KEY (to_user_id) 
  REFERENCES users (id)
  ON DELETE CASCADE;

-- Подписки на пользователя
ALTER TABLE subscribtions_users
  ADD CONSTRAINT subscribtions_users_subscribed_by_user_id_fk
  FOREIGN KEY (subscribed_by_user_id) 
  REFERENCES users (id)
  ON DELETE CASCADE;

ALTER TABLE subscribtions_users 
  ADD CONSTRAINT subscribtions_users_subscribed_to_user_id_fk
  FOREIGN KEY (subscribed_to_user_id) 
  REFERENCES users (id)
  ON DELETE CASCADE;
  
ALTER TABLE subscribtions_users
  ADD CONSTRAINT subscribtions_users_status_id_fk
  FOREIGN KEY (status_id) 
  REFERENCES subscribe_statuses (id)
  ON DELETE RESTRICT;

-- Подписки на сообщества
ALTER TABLE subscribtions_communities
  ADD CONSTRAINT subscribtions_communities_subscribed_by_user_id_fk
  FOREIGN KEY (subscribed_by_user_id) 
  REFERENCES users (id)
  ON DELETE CASCADE;

ALTER TABLE subscribtions_communities 
  ADD CONSTRAINT subscribtions_communities_subscribed_to_community_id_fk
  FOREIGN KEY (subscribed_to_community_id) 
  REFERENCES communities (id)
  ON DELETE CASCADE;
  
ALTER TABLE subscribtions_communities
  ADD CONSTRAINT subscribtions_communities_status_id_fk
  FOREIGN KEY (status_id) 
  REFERENCES subscribe_statuses (id)
  ON DELETE RESTRICT;

-- Дружба
ALTER TABLE friendship
  ADD CONSTRAINT friendship_requested_by_user_id_fk
  FOREIGN KEY (requested_by_user_id) 
  REFERENCES users (id)
  ON DELETE CASCADE;

ALTER TABLE friendship
  ADD CONSTRAINT friendship_requested_to_user_id_fk
  FOREIGN KEY (requested_to_user_id) 
  REFERENCES users (id)
  ON DELETE CASCADE;
   
ALTER TABLE friendship
  ADD CONSTRAINT friendship_status_id_fk
  FOREIGN KEY (status_id) 
  REFERENCES friendship_statuses (id)
  ON DELETE RESTRICT;

-- Сообщества пользователей
ALTER TABLE public.communities_users
  ADD CONSTRAINT communities_users_user_id_fk
  FOREIGN KEY (user_id) 
  REFERENCES users (id)
  ON DELETE CASCADE;
   
ALTER TABLE public.communities_users
  ADD CONSTRAINT communities_users_community_id_fk
  FOREIGN KEY (community_id) 
  REFERENCES public.communities (id)
  ON DELETE CASCADE;

-- Сообщества
ALTER TABLE public.communities
  ADD CONSTRAINT communities_creator_id_fk
  FOREIGN KEY (creator_id) 
  REFERENCES users (id)
  ON DELETE RESTRICT;


-- 3. Создать в таблице фотографий столбец metadata типа JSON и следующими ключами - id, url, size и заполнить его 
-- значениями соответствующих строк. В отчёт приложить команды ALTER TABLE и UPDATE.

ALTER TABLE photo ADD COLUMN metadata JSON;

-- Создадим новые значения с помощью функции json_build_object, 
-- которая облегчает компоновку структуры, состоящей из пар ключ-значение
UPDATE photo SET metadata = json_build_object(
  'id', id,
  'url', url,
  'size', size
);



-- 4. В таблице сообществ создать столбец members типа массив. Для сообщества с id = 3 поместить в ячейку members 
-- идентификаторы всех пользователей, являющихся членами данной группы.
-- В отчёт приложить выполняемые команды.

ALTER TABLE communities ADD COLUMN members INT[];

-- Не очень красивый update с вложенным запросом, но учитывая что нужна только одна запись думаю сойдет
UPDATE communities SET members = (SELECT ARRAY_AGG(user_id) FROM communities_users WHERE community_id = 3) WHERE id = 3;

select members from communities where id=3;




-- 5. Создать пользовательский составной тип данных contacts c полями phone и email. 
-- В таблице пользователей добавить столбец user_contacts типа contacts. Заполнить столбец значениями из соответствующих строк. 
-- Для пользователя с id = 21 изменить email в столбце user_contacts на test@somemail.ru. В отчёт приложить выполненные команды.

CREATE TYPE contacts AS (phone VARCHAR(15), email VARCHAR(120));

ALTER TABLE users ADD COLUMN user_contacts contacts;

UPDATE users SET user_contacts = (phone, email);

UPDATE users SET user_contacts.email = 'test@somemail.ru' WHERE id = 3;
SELECT * FROM users WHERE id = 3;





